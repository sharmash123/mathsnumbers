<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Number-Cal: Link Charts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        .initial-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 500px;
            margin: 4rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .initial-form:hover {
            transform: translateY(-5px);
        }
        .link-container {
            overflow-x: auto;
            margin: 2rem auto;
            max-width: 90%;
        }
        .link-table {
            border-collapse: collapse;
            margin: 1rem auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-width: 600px;
        }
        .link-td {
            border: 1px solid #e5e7eb;
            width: 100px;
            height: 100px;
            text-align: center;
            font-size: 24px;
            font-weight: 500;
            background-color: #f9fafb;
            vertical-align: middle;
            padding: 8px;
            transition: background-color 0.3s ease;
        }
        .link-td:hover {
            background-color: #e5e7eb;
        }
        .checkbox-container {
            position: relative;
            display: inline-block;
            width: 100%;
            height: 100%;
        }
        .checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
        }
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: #ffffff;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checkbox-container:hover .checkmark {
            border-color: #9ca3af;
        }
        .checkbox-container input[type="checkbox"]:checked ~ .checkmark {
            background-color: #4b5563;
            border-color: #4b5563;
            color: #ffffff;
        }
        .checkmark:after {
            content: "âœ“";
            font-size: 24px;
            color: #ffffff;
            display: none;
        }
        .checkbox-container input[type="checkbox"]:checked ~ .checkmark:after {
            display: block;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 1024px) {
            .link-td {
                width: 80px;
                height: 80px;
                font-size: 20px;
            }
        }
        @media (max-width: 600px) {
            .link-td {
                width: 60px;
                height: 60px;
                font-size: 16px;
            }
            .initial-form {
                margin: 2rem auto;
                padding: 1.5rem;
            }
            .link-container {
                margin: 1rem auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-poppins">
    <header class="bg-gray-800 text-white p-4 flex justify-between items-center flex-wrap">
        <h1 class="text-xl md:text-2xl font-bold mb-2 md:mb-0">Number-Cal: Link Charts</h1>
        <nav class="flex gap-4">
            <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">
                Charts
            </a>
            <a href="store.html" class="bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-4 rounded-full transition-colors duration-300">
                Store
            </a>
            <a href="info.html" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">
                Tables
            </a>
        </nav>
    </header>

    <div id="initial-setup" class="initial-form animate-fadeIn">
        <h2 class="text-2xl font-semibold text-center mb-2">Create Chart Link</h2>
        <input type="text" id="link-name-input" placeholder="Enter Link Name" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500">
        <select id="chart1-select" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500">
            <option value="">Select First Chart</option>
        </select>
        <select id="chart2-select" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500">
            <option value="">Select Second Chart</option>
        </select>
        <button id="create-link-btn" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors duration-300 flex items-center justify-center gap-2">
            Create Link
            <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </div>

    <div id="link-main" class="container mx-auto p-4 md:p-8 hidden">
        <h2 class="text-2xl font-semibold mb-4 text-center"></h2>
        <div class="input-box flex flex-wrap justify-center items-center gap-4 mb-8">
            <button id="save-link-btn" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors duration-300 flex items-center justify-center gap-2">
                Save Link
                <svg id="save-symbol" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div class="link-container">
            <h3 class="text-xl font-semibold text-center mb-2">Open Conditions</h3>
            <table class="link-table">
                <tbody id="open-table"></tbody>
            </table>
            <h3 class="text-xl font-semibold text-center mb-2 mt-4">Close Conditions</h3>
            <table class="link-table">
                <tbody id="close-table"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentLinkName = null;
        const chartNameHeader = document.querySelector("#link-main h2");
        const createLinkBtn = document.getElementById('create-link-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const saveLinkBtn = document.getElementById('save-link-btn');
        const saveSymbol = document.getElementById('save-symbol');
        const chart1Select = document.getElementById('chart1-select');
        const chart2Select = document.getElementById('chart2-select');
        const openTable = document.getElementById('open-table');
        const closeTable = document.getElementById('close-table');

        function populateChartSelects() {
            const history = JSON.parse(localStorage.getItem('chartHistory')) || {};
            chart1Select.innerHTML = '<option value="">Select First Chart</option>';
            chart2Select.innerHTML = '<option value="">Select Second Chart</option>';
            Object.keys(history).forEach(chartName => {
                const option1 = document.createElement('option');
                const option2 = document.createElement('option');
                option1.value = chartName;
                option2.value = chartName;
                option1.textContent = chartName;
                option2.textContent = chartName;
                chart1Select.appendChild(option1);
                chart2Select.appendChild(option2);
            });
        }

        function renderLinkedTables(chart1Data, chart2Data) {
            const minRows = Math.min(chart1Data.rows, chart2Data.rows);
            openTable.innerHTML = '';
            closeTable.innerHTML = '';
            for (let r = 0; r < minRows; r++) {
                const trOpen = document.createElement('tr');
                const trClose = document.createElement('tr');
                for (let c = 0; c < Math.min(chart1Data.cols, chart2Data.cols); c++) {
                    const tdOpen = document.createElement('td');
                    const tdClose = document.createElement('td');
                    tdOpen.className = 'link-td';
                    tdClose.className = 'link-td';
                    const val1 = chart1Data.data[r][c]?.val || '';
                    const val2 = chart2Data.data[r][c]?.val || '';
                    tdOpen.textContent = val1 === '*' || val1 === '**' ? '**' : (chart1Data.data[r][c]?.cn || '');
                    tdClose.textContent = val2 === '*' || val2 === '**' ? '**' : (chart2Data.data[r][c]?.close || '');
                    trOpen.appendChild(tdOpen);
                    trClose.appendChild(tdClose);
                }
                openTable.appendChild(trOpen);
                closeTable.appendChild(trClose);
            }
        }

        function saveLink() {
            const linkName = currentLinkName;
            const chart1Name = chart1Select.value;
            const chart2Name = chart2Select.value;
            if (!linkName || !chart1Name || !chart2Name || chart1Name === chart2Name) {
                alert('Please select different charts and enter a valid link name.');
                return;
            }
            const linkHistory = JSON.parse(localStorage.getItem('linkHistory')) || {};
            linkHistory[linkName] = { chart1: chart1Name, chart2: chart2Name };
            localStorage.setItem('linkHistory', JSON.stringify(linkHistory));
            saveLinkBtn.disabled = true;
            saveSymbol.classList.remove('hidden');
            saveLinkBtn.classList.add('animate-pulse');
            saveLinkBtn.textContent = 'Saved!';
            setTimeout(() => {
                saveLinkBtn.disabled = false;
                saveSymbol.classList.add('hidden');
                saveLinkBtn.classList.remove('animate-pulse');
                saveLinkBtn.textContent = 'Save Link';
            }, 1000);
        }

        createLinkBtn.addEventListener('click', () => {
            const name = document.getElementById('link-name-input').value.trim();
            const chart1 = chart1Select.value;
            const chart2 = chart2Select.value;
            if (!name || !chart1 || !chart2 || chart1 === chart2) {
                alert('Please enter a link name and select two different charts.');
                return;
            }
            createLinkBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            setTimeout(() => {
                currentLinkName = name;
                chartNameHeader.textContent = `Linking: ${currentLinkName}`;
                document.getElementById('initial-setup').classList.add('hidden');
                document.getElementById('link-main').classList.remove('hidden');
                const history = JSON.parse(localStorage.getItem('chartHistory')) || {};
                const chart1Data = history[chart1];
                const chart2Data = history[chart2];
                renderLinkedTables(chart1Data, chart2Data);
                createLinkBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
            }, 500);
        });

        saveLinkBtn.addEventListener('click', saveLink);

        populateChartSelects();
    </script>
</body>
</html>
